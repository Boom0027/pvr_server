<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: src/service/movieService.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: src/service/movieService.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Movie service
 * Author: Tirthamouli Baidya
 */

// Validation helper
const validationHelper = require("../helper/validationHelper")

// Exception
const BadRequest = require("../exception/badRequestException")

// Email library
const sendMail = require("../lib/mailLibrary")

/**
 * Verifying and mapping shows
 * @param {Array} shows
 * @param {Model} MovieModel 
 */
async function showVerifier(shows, MovieModel) {
    // Step 1: Checking if show is an array
    if (shows.constructor.name !== 'Array') {
        return false
    }

    // Step 2: Mapping value
    const res = []
    const theatreIdArray = []
    const idCheck = {}
    for (let i = 0; i &lt; shows.length; i++) {
        // Step 2.1: Validate
        const startV = validationHelper.dateToMysqlFormat(shows[i].start)
        const endV = validationHelper.dateToMysqlFormat(shows[i].end)
        if (!startV || !endV) {
            return false
        }

        // Step 2.2: Check if we have already inserted the theatre id - Preventing multi inserts
        if (idCheck.hasOwnProperty(shows[i].theatreId)) {
            continue
        }
        idCheck[shows[i].theatreId] = true

        // Step 2.3: Push in res
        res.push({
            startsAt: startV,
            endsAt: endV,
            TheatreId: shows[i].theatreId
        })

        // Step 2.4: Push in theatreIdArray
        theatreIdArray.push(shows[i].theatreId)
    }
    // Step 3: Check if all theatre ids exists
    const theatresExists = await MovieModel.checkIfTheatresExists(theatreIdArray)
    if (!theatresExists) {
        return false
    }

    // Step 4: Return the res
    return res
}

/**
 * Movie service layer
 */
class MovieService {
    /**
     * Dependency injection
     * @param {Model} MovieModel 
     */
    constructor({ MovieModel }) {
        this.MovieModel = MovieModel
    }

    /**
     * Add a new movie
     * @param {String} firstName
     * @param {String} start
     * @param {String} end
     * @param {String} theatreId
     */
    async add({ name, description, shows }) {
        // Step 1: Validate and format
        const nameV = validationHelper.movieOrTheatreName(name)
        const descriptionV = validationHelper.description(description)
        const showsV = await showVerifier(shows, this.MovieModel)
        if (!nameV || !descriptionV || !showsV) {
            throw new BadRequest("invalid data")
        }

        // Step 2: Create the new movie
        const movie = await this.MovieModel.addNewMovie({
            name: nameV,
            description: descriptionV,
            values: showsV
        })

        // Step 3: Return the newly created movie
        return {
            movie: {
                id: movie.id,
                name: name,
                description: descriptionV
            },
            message: "movie added successfully"
        }
    }

    /**
     * Search a movie by name
     * @param {String} search 
     * @param {Number} page 
     */
    async search({ value = '', page = 0 }) {
        // Step 1: Validate and format
        const searchV = validationHelper.simpleStringCheck(value)
        const pageV = validationHelper.intCheck(page)
        if (searchV === false || page === false) {
            throw new BadRequest("invalid data")
        }

        // Step 2: Get the result
        const movies = await this.MovieModel.searchMovieByName({ name: searchV, limit: 15, offset: pageV * 15 })

        // Step 3: Format response
        const movieRes = movies.map(movie => {
            return {
                id: movie.id,
                name: movie.name,
                description: movie.description
            }
        })

        // Step 4: Return the res
        return {
            movies: movieRes
        }
    }

    /**
     * Send mail notifying about movie
     * @param {String} movieId 
     */
    async sendMail({ movieId }) {
        // Step 1: Get movie name and description from id and check if it exists
        const movie = await this.MovieModel.getMovieById({ movieId })
        if (movie === null) {
            throw new BadRequest("invalid data")
        }

        // Step 2: Get all the user email
        const users = await this.MovieModel.getUsersForMovie({ movieId })

        // Step 3: Generate the email array
        const emailArr = users.map(user => {
            return user.email
        })

        // Step 4: Check if email array is empty
        if (emailArr.length === 0) {
            throw new BadRequest("No one to notify")
        }

        // Step 5: Generate some random title, incase of a real project we should create a template for the message
        const title = `${movie.name} now in your city!!`
        const body = `${movie.name} is now in your city.\nWant to know about '${movie.description}'?\nPVRCinema in your city is now plaing ${movie.name}.\nWatch today!!`

        // Step 6: Send the mail
        await sendMail({
            to: emailArr,
            subject: title,
            text: body
        })

        // Step 7: Return the res
        return {
            message: 'Email successfully sent'
        }
    }
}
module.exports = MovieService</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Auth.html">Auth</a></li><li><a href="AuthController.html">AuthController</a></li><li><a href="AuthService.html">AuthService</a></li><li><a href="BadRequest.html">BadRequest</a></li><li><a href="City.html">City</a></li><li><a href="Forbidden.html">Forbidden</a></li><li><a href="InternalServer.html">InternalServer</a></li><li><a href="Movie.html">Movie</a></li><li><a href="MovieController.html">MovieController</a></li><li><a href="MovieService.html">MovieService</a></li><li><a href="Show.html">Show</a></li><li><a href="Theatre.html">Theatre</a></li><li><a href="TheatreController.html">TheatreController</a></li><li><a href="TheatreService.html">TheatreService</a></li><li><a href="User.html">User</a></li><li><a href="UserController.html">UserController</a></li><li><a href="UserService.html">UserService</a></li></ul><h3>Global</h3><ul><li><a href="global.html#authRoutes">authRoutes</a></li><li><a href="global.html#bcrypt">bcrypt</a></li><li><a href="global.html#compare">compare</a></li><li><a href="global.html#description">description</a></li><li><a href="global.html#email">email</a></li><li><a href="global.html#endsAt">endsAt</a></li><li><a href="global.html#express">express</a></li><li><a href="global.html#firstName">firstName</a></li><li><a href="global.html#hash">hash</a></li><li><a href="global.html#id">id</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#jwt">jwt</a></li><li><a href="global.html#lastName">lastName</a></li><li><a href="global.html#logger">logger</a></li><li><a href="global.html#name">name</a></li><li><a href="global.html#nodemailer">nodemailer</a></li><li><a href="global.html#password">password</a></li><li><a href="global.html#patterns">patterns</a></li><li><a href="global.html#pool">pool</a></li><li><a href="global.html#showVerifier">showVerifier</a></li><li><a href="global.html#sign">sign</a></li><li><a href="global.html#startsAt">startsAt</a></li><li><a href="global.html#transporter">transporter</a></li><li><a href="global.html#twoDigits">twoDigits</a></li><li><a href="global.html#username">username</a></li><li><a href="global.html#verify">verify</a></li><li><a href="global.html#verifyToken">verifyToken</a></li><li><a href="global.html#winston">winston</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Tue Feb 25 2020 02:20:23 GMT+0530 (India Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
